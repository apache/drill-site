<!DOCTYPE HTML>
<html lang="en">
<head>
<!-- Generated by javadoc (17) -->
<title>SortMemoryManager (Drill : 1.21.2-SNAPSHOT API)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="description" content="declaration: package: org.apache.drill.exec.physical.impl.xsort, class: SortMemoryManager">
<meta name="generator" content="javadoc/ClassWriterImpl">
<link rel="stylesheet" type="text/css" href="../../../../../../../stylesheet.css" title="Style">
<link rel="stylesheet" type="text/css" href="../../../../../../../script-dir/jquery-ui.min.css" title="Style">
<link rel="stylesheet" type="text/css" href="../../../../../../../jquery-ui.overrides.css" title="Style">
<script type="text/javascript" src="../../../../../../../script.js"></script>
<script type="text/javascript" src="../../../../../../../script-dir/jquery-3.6.1.min.js"></script>
<script type="text/javascript" src="../../../../../../../script-dir/jquery-ui.min.js"></script>
</head>
<body class="class-declaration-page">
<script type="text/javascript">var evenRowColor = "even-row-color";
var oddRowColor = "odd-row-color";
var tableTab = "table-tab";
var activeTableTab = "active-table-tab";
var pathtoroot = "../../../../../../../";
loadScripts(document, 'script');</script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<div class="flex-box">
<header role="banner" class="flex-header">
<nav role="navigation">
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="top-nav" id="navbar-top">
<div class="skip-nav"><a href="#skip-navbar-top" title="Skip navigation links">Skip navigation links</a></div>
<ul id="navbar-top-firstrow" class="nav-list" title="Navigation">
<li><a href="../../../../../../../index.html">Overview</a></li>
<li><a href="package-summary.html">Package</a></li>
<li class="nav-bar-cell1-rev">Class</li>
<li><a href="class-use/SortMemoryManager.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../../../../index-all.html">Index</a></li>
<li><a href="../../../../../../../help-doc.html#class">Help</a></li>
</ul>
</div>
<div class="sub-nav">
<div>
<ul class="sub-nav-list">
<li>Summary:&nbsp;</li>
<li><a href="#nested-class-summary">Nested</a>&nbsp;|&nbsp;</li>
<li><a href="#field-summary">Field</a>&nbsp;|&nbsp;</li>
<li><a href="#constructor-summary">Constr</a>&nbsp;|&nbsp;</li>
<li><a href="#method-summary">Method</a></li>
</ul>
<ul class="sub-nav-list">
<li>Detail:&nbsp;</li>
<li><a href="#field-detail">Field</a>&nbsp;|&nbsp;</li>
<li><a href="#constructor-detail">Constr</a>&nbsp;|&nbsp;</li>
<li><a href="#method-detail">Method</a></li>
</ul>
</div>
<div class="nav-list-search"><label for="search-input">SEARCH:</label>
<input type="text" id="search-input" value="search" disabled="disabled">
<input type="reset" id="reset-button" value="reset" disabled="disabled">
</div>
</div>
<!-- ========= END OF TOP NAVBAR ========= -->
<span class="skip-nav" id="skip-navbar-top"></span></nav>
</header>
<div class="flex-content">
<main role="main">
<!-- ======== START OF CLASS DATA ======== -->
<div class="header">
<div class="sub-title"><span class="package-label-in-type">Package</span>&nbsp;<a href="package-summary.html">org.apache.drill.exec.physical.impl.xsort</a></div>
<h1 title="Class SortMemoryManager" class="title">Class SortMemoryManager</h1>
</div>
<div class="inheritance" title="Inheritance Tree"><a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html" title="class or interface in java.lang" class="external-link">java.lang.Object</a>
<div class="inheritance">org.apache.drill.exec.physical.impl.xsort.SortMemoryManager</div>
</div>
<section class="class-description" id="class-description">
<hr>
<div class="type-signature"><span class="modifiers">public class </span><span class="element-name type-name-label">SortMemoryManager</span>
<span class="extends-implements">extends <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html" title="class or interface in java.lang" class="external-link">Object</a></span></div>
<div class="block">Computes the memory needs for input batches, spill batches and merge
 batches. The key challenges that this code tries to overcome are:
 <ul>
 <li>Drill is not designed for the small memory allocations,
 but the planner may provide such allocations because the memory per
 query is divided among slices (minor fragments) and among buffering
 operators, leaving very little per operator.</li>
 <li>Drill does not provide the detailed memory information needed to
 carefully manage memory in tight constraints.</li>
 <li>But, Drill has a death penalty for going over the memory limit.</li>
 </ul>
 As a result, this class is a bit of a hack: it attempt to consider a
 number of ill-defined factors in order to divide up memory use in a
 way that prevents OOM errors.
 <p>
 First, it is necessary to differentiate two concepts:
 <ul>
 <li>The <i>data size</i> of a batch: the amount of memory needed to hold
 the data itself. The data size is constant for any given batch.</li>
 <li>The <i>buffer size</i> of the buffers that hold the data. The buffer
 size varies wildly depending on how the batch was produced.</li>
 </ul>
 The three kinds of buffer layouts seen to date include:
 <ul>
 <li>One buffer per vector component (data, offsets, null flags, etc.)
 &ndash; create by readers, project and other operators.</li>
 <li>One buffer for the entire batch, with each vector component using
 a slice of the overall buffer. &ndash; case for batches deserialized from
 exchanges.</li>
 <li>One buffer for each top-level vector, with component vectors
 using slices of the overall vector buffer &ndash; the result of reading
 spilled batches from disk.</li>
 </ul>
 In each case, buffer sizes are power-of-two rounded from the data size.
 But since the data is grouped differently in each case, the resulting buffer
 sizes vary considerably.
 <p>
 As a result, we can never be sure of the amount of memory needed for a
 batch. So, we have to estimate based on a number of factors:
 <ul>
 <li>Uses the <a href="../../../record/RecordBatchSizer.html" title="class in org.apache.drill.exec.record"><code>RecordBatchSizer</code></a> to estimate the data size and
 buffer size of each incoming batch.</li>
 <li>Estimates the internal fragmentation due to power-of-two rounding.</li>
 <li>Configured preferences for spill and output batches.</li>
 </ul>
 The code handles "normal" and "low" memory conditions.
 <ul>
 <li>In normal memory, we simply work out the number of preferred-size
 batches that fit in memory (based on the predicted buffer size.)</li>
 <li>In low memory, we divide up the available memory to produce the
 spill and merge batch sizes. The sizes will be less than the configured
 preference.</li>
 </ul>
 <p>
 The sort has two key configured parameters: the spill file size and the
 size of the output (downstream) batch. The spill file size is chosen to
 be large enough to ensure efficient I/O, but not so large as to overwhelm
 any one spill directory. The output batch size is chosen to be large enough
 to amortize the per-batch overhead over the maximum number of records, but
 not so large as to overwhelm downstream operators. Setting these parameters
 is a judgment call.
 <p>
 Under limited memory, the above sizes may be too big for the space available.
 For example, the default spill file size is 256 MB. But, if the sort is
 only given 50 MB, then spill files will be smaller. The default output batch
 size is 16 MB, but if the sort is given only 20 MB, then the output batch must
 be smaller. The low memory logic starts with the memory available and works
 backwards to figure out spill batch size, output batch size and spill file
 size. The sizes will be smaller than optimal, but as large as will fit in
 the memory provided.</div>
</section>
<section class="summary">
<ul class="summary-list">
<!-- ======== NESTED CLASS SUMMARY ======== -->
<li>
<section class="nested-class-summary" id="nested-class-summary">
<h2>Nested Class Summary</h2>
<div class="caption"><span>Nested Classes</span></div>
<div class="summary-table three-column-summary">
<div class="table-header col-first">Modifier and Type</div>
<div class="table-header col-second">Class</div>
<div class="table-header col-last">Description</div>
<div class="col-first even-row-color"><code>static class&nbsp;</code></div>
<div class="col-second even-row-color"><code><a href="SortMemoryManager.BatchSizeEstimate.html" class="type-name-link" title="class in org.apache.drill.exec.physical.impl.xsort">SortMemoryManager.BatchSizeEstimate</a></code></div>
<div class="col-last even-row-color">&nbsp;</div>
<div class="col-first odd-row-color"><code>static enum&nbsp;</code></div>
<div class="col-second odd-row-color"><code><a href="SortMemoryManager.MergeAction.html" class="type-name-link" title="enum in org.apache.drill.exec.physical.impl.xsort">SortMemoryManager.MergeAction</a></code></div>
<div class="col-last odd-row-color">&nbsp;</div>
<div class="col-first even-row-color"><code>static class&nbsp;</code></div>
<div class="col-second even-row-color"><code><a href="SortMemoryManager.MergeTask.html" class="type-name-link" title="class in org.apache.drill.exec.physical.impl.xsort">SortMemoryManager.MergeTask</a></code></div>
<div class="col-last even-row-color">&nbsp;</div>
</div>
</section>
</li>
<!-- =========== FIELD SUMMARY =========== -->
<li>
<section class="field-summary" id="field-summary">
<h2>Field Summary</h2>
<div class="caption"><span>Fields</span></div>
<div class="summary-table three-column-summary">
<div class="table-header col-first">Modifier and Type</div>
<div class="table-header col-second">Field</div>
<div class="table-header col-last">Description</div>
<div class="col-first even-row-color"><code>static final double</code></div>
<div class="col-second even-row-color"><code><a href="#BUFFER_FROM_PAYLOAD" class="member-name-link">BUFFER_FROM_PAYLOAD</a></code></div>
<div class="col-last even-row-color">
<div class="block">Given a data size, this is the multiplier to create the buffer
 size estimate.</div>
</div>
<div class="col-first odd-row-color"><code>static final double</code></div>
<div class="col-second odd-row-color"><code><a href="#INTERNAL_FRAGMENTATION_ESTIMATE" class="member-name-link">INTERNAL_FRAGMENTATION_ESTIMATE</a></code></div>
<div class="col-last odd-row-color">
<div class="block">Estimate for typical internal fragmentation in a buffer due to power-of-two
 rounding on vectors.</div>
</div>
<div class="col-first even-row-color"><code>static final double</code></div>
<div class="col-second even-row-color"><code><a href="#LOW_MEMORY_MERGE_BATCH_RATIO" class="member-name-link">LOW_MEMORY_MERGE_BATCH_RATIO</a></code></div>
<div class="col-last even-row-color">&nbsp;</div>
<div class="col-first odd-row-color"><code>static final int</code></div>
<div class="col-second odd-row-color"><code><a href="#MIN_ROWS_PER_SORT_BATCH" class="member-name-link">MIN_ROWS_PER_SORT_BATCH</a></code></div>
<div class="col-last odd-row-color">
<div class="block">Desperate attempt to keep spill batches from being too small in low memory.</div>
</div>
<div class="col-first even-row-color"><code>static final double</code></div>
<div class="col-second even-row-color"><code><a href="#PAYLOAD_FROM_BUFFER" class="member-name-link">PAYLOAD_FROM_BUFFER</a></code></div>
<div class="col-last even-row-color">
<div class="block">Given a buffer, this is the assumed amount of space
 available for data.</div>
</div>
<div class="col-first odd-row-color"><code>static final double</code></div>
<div class="col-second odd-row-color"><code><a href="#WORST_CASE_BUFFER_RATIO" class="member-name-link">WORST_CASE_BUFFER_RATIO</a></code></div>
<div class="col-last odd-row-color">
<div class="block">On really bad days, we will add one more byte (or value) to a vector
 than fits in a power-of-two sized buffer, forcing a doubling.</div>
</div>
</div>
</section>
</li>
<!-- ======== CONSTRUCTOR SUMMARY ======== -->
<li>
<section class="constructor-summary" id="constructor-summary">
<h2>Constructor Summary</h2>
<div class="caption"><span>Constructors</span></div>
<div class="summary-table two-column-summary">
<div class="table-header col-first">Constructor</div>
<div class="table-header col-last">Description</div>
<div class="col-constructor-name even-row-color"><code><a href="#%3Cinit%3E(org.apache.drill.exec.physical.impl.xsort.SortConfig,long)" class="member-name-link">SortMemoryManager</a><wbr>(<a href="SortConfig.html" title="class in org.apache.drill.exec.physical.impl.xsort">SortConfig</a>&nbsp;config,
 long&nbsp;opMemoryLimit)</code></div>
<div class="col-last even-row-color">&nbsp;</div>
</div>
</section>
</li>
<!-- ========== METHOD SUMMARY =========== -->
<li>
<section class="method-summary" id="method-summary">
<h2>Method Summary</h2>
<div id="method-summary-table">
<div class="table-tabs" role="tablist" aria-orientation="horizontal"><button id="method-summary-table-tab0" role="tab" aria-selected="true" aria-controls="method-summary-table.tabpanel" tabindex="0" onkeydown="switchTab(event)" onclick="show('method-summary-table', 'method-summary-table', 3)" class="active-table-tab">All Methods</button><button id="method-summary-table-tab1" role="tab" aria-selected="false" aria-controls="method-summary-table.tabpanel" tabindex="-1" onkeydown="switchTab(event)" onclick="show('method-summary-table', 'method-summary-table-tab1', 3)" class="table-tab">Static Methods</button><button id="method-summary-table-tab2" role="tab" aria-selected="false" aria-controls="method-summary-table.tabpanel" tabindex="-1" onkeydown="switchTab(event)" onclick="show('method-summary-table', 'method-summary-table-tab2', 3)" class="table-tab">Instance Methods</button><button id="method-summary-table-tab4" role="tab" aria-selected="false" aria-controls="method-summary-table.tabpanel" tabindex="-1" onkeydown="switchTab(event)" onclick="show('method-summary-table', 'method-summary-table-tab4', 3)" class="table-tab">Concrete Methods</button></div>
<div id="method-summary-table.tabpanel" role="tabpanel">
<div class="summary-table three-column-summary" aria-labelledby="method-summary-table-tab0">
<div class="table-header col-first">Modifier and Type</div>
<div class="table-header col-second">Method</div>
<div class="table-header col-last">Description</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="SortMemoryManager.MergeTask.html" title="class in org.apache.drill.exec.physical.impl.xsort">SortMemoryManager.MergeTask</a></code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#consolidateBatches(long,int,int)" class="member-name-link">consolidateBatches</a><wbr>(long&nbsp;allocMemory,
 int&nbsp;inMemCount,
 int&nbsp;spilledRunsCount)</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Choose a consolidation option during the merge phase depending on memory
 available.</div>
</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>long</code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#freeMemory(long)" class="member-name-link">freeMemory</a><wbr>(long&nbsp;allocatedBytes)</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">&nbsp;</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>long</code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#getBufferMemoryLimit()" class="member-name-link">getBufferMemoryLimit</a>()</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">&nbsp;</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="SortMemoryManager.BatchSizeEstimate.html" title="class in org.apache.drill.exec.physical.impl.xsort">SortMemoryManager.BatchSizeEstimate</a></code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#getInputBatchSize()" class="member-name-link">getInputBatchSize</a>()</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">&nbsp;</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>long</code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#getMemoryLimit()" class="member-name-link">getMemoryLimit</a>()</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">&nbsp;</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>int</code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#getMergeBatchRowCount()" class="member-name-link">getMergeBatchRowCount</a>()</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">&nbsp;</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="SortMemoryManager.BatchSizeEstimate.html" title="class in org.apache.drill.exec.physical.impl.xsort">SortMemoryManager.BatchSizeEstimate</a></code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#getMergeBatchSize()" class="member-name-link">getMergeBatchSize</a>()</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">&nbsp;</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>long</code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#getMergeMemoryLimit()" class="member-name-link">getMergeMemoryLimit</a>()</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">&nbsp;</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>int</code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#getPreferredMergeBatchSize()" class="member-name-link">getPreferredMergeBatchSize</a>()</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">&nbsp;</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>int</code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#getPreferredSpillBatchSize()" class="member-name-link">getPreferredSpillBatchSize</a>()</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">&nbsp;</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>int</code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#getRowWidth()" class="member-name-link">getRowWidth</a>()</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">&nbsp;</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>int</code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#getSpillBatchRowCount()" class="member-name-link">getSpillBatchRowCount</a>()</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">&nbsp;</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="SortMemoryManager.BatchSizeEstimate.html" title="class in org.apache.drill.exec.physical.impl.xsort">SortMemoryManager.BatchSizeEstimate</a></code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#getSpillBatchSize()" class="member-name-link">getSpillBatchSize</a>()</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">&nbsp;</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>boolean</code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#hasMemoryMergeCapacity(long,long)" class="member-name-link">hasMemoryMergeCapacity</a><wbr>(long&nbsp;allocatedBytes,
 long&nbsp;neededForInMemorySort)</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">&nbsp;</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>boolean</code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#hasPerformanceWarning()" class="member-name-link">hasPerformanceWarning</a>()</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">&nbsp;</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>boolean</code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#isLowMemory()" class="member-name-link">isLowMemory</a>()</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">&nbsp;</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>boolean</code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#isSpillNeeded(long,long)" class="member-name-link">isSpillNeeded</a><wbr>(long&nbsp;allocatedBytes,
 long&nbsp;incomingSize)</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">&nbsp;</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>boolean</code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#mayOverflow()" class="member-name-link">mayOverflow</a>()</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">&nbsp;</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab1 method-summary-table-tab4"><code>static int</code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab1 method-summary-table-tab4"><code><a href="#multiply(int,double)" class="member-name-link">multiply</a><wbr>(int&nbsp;byteSize,
 double&nbsp;multiplier)</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab1 method-summary-table-tab4">&nbsp;</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>boolean</code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#updateEstimates(int,int,int)" class="member-name-link">updateEstimates</a><wbr>(int&nbsp;batchDataSize,
 int&nbsp;batchRowWidth,
 int&nbsp;batchRowCount)</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Update the data-driven memory use numbers including:
 
 The average size of incoming records.
 The estimated spill and output batch size.
 The estimated number of average-size records per
 spill and output batch.
 The amount of memory set aside to hold the incoming
 batches before spilling starts.
 </div>
</div>
</div>
</div>
</div>
<div class="inherited-list">
<h3 id="methods-inherited-from-class-java.lang.Object">Methods inherited from class&nbsp;java.lang.<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html" title="class or interface in java.lang" class="external-link">Object</a></h3>
<code><a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html#clone--" title="class or interface in java.lang" class="external-link">clone</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html#equals-java.lang.Object-" title="class or interface in java.lang" class="external-link">equals</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html#finalize--" title="class or interface in java.lang" class="external-link">finalize</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html#getClass--" title="class or interface in java.lang" class="external-link">getClass</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html#hashCode--" title="class or interface in java.lang" class="external-link">hashCode</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html#notify--" title="class or interface in java.lang" class="external-link">notify</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html#notifyAll--" title="class or interface in java.lang" class="external-link">notifyAll</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html#toString--" title="class or interface in java.lang" class="external-link">toString</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html#wait--" title="class or interface in java.lang" class="external-link">wait</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html#wait-long-" title="class or interface in java.lang" class="external-link">wait</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html#wait-long-int-" title="class or interface in java.lang" class="external-link">wait</a></code></div>
</section>
</li>
</ul>
</section>
<section class="details">
<ul class="details-list">
<!-- ============ FIELD DETAIL =========== -->
<li>
<section class="field-details" id="field-detail">
<h2>Field Details</h2>
<ul class="member-list">
<li>
<section class="detail" id="INTERNAL_FRAGMENTATION_ESTIMATE">
<h3>INTERNAL_FRAGMENTATION_ESTIMATE</h3>
<div class="member-signature"><span class="modifiers">public static final</span>&nbsp;<span class="return-type">double</span>&nbsp;<span class="element-name">INTERNAL_FRAGMENTATION_ESTIMATE</span></div>
<div class="block">Estimate for typical internal fragmentation in a buffer due to power-of-two
 rounding on vectors.
 <p>
 <p>
 <pre>[____|__$__]</pre>
 In the above, the brackets represent the whole vector. The
 first half is always full. The $ represents the end of data.
 When the first half filled, the second
 half was allocated. On average, the second half will be half full.
 This means that, on average, 1/4 of the allocated space is
 unused (the definition of internal fragmentation.)</div>
<dl class="notes">
<dt>See Also:</dt>
<dd>
<ul class="see-list">
<li><a href="../../../../../../../constant-values.html#org.apache.drill.exec.physical.impl.xsort.SortMemoryManager.INTERNAL_FRAGMENTATION_ESTIMATE">Constant Field Values</a></li>
</ul>
</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="PAYLOAD_FROM_BUFFER">
<h3>PAYLOAD_FROM_BUFFER</h3>
<div class="member-signature"><span class="modifiers">public static final</span>&nbsp;<span class="return-type">double</span>&nbsp;<span class="element-name">PAYLOAD_FROM_BUFFER</span></div>
<div class="block">Given a buffer, this is the assumed amount of space
 available for data. (Adding more will double the buffer
 size half the time.)</div>
<dl class="notes">
<dt>See Also:</dt>
<dd>
<ul class="see-list">
<li><a href="../../../../../../../constant-values.html#org.apache.drill.exec.physical.impl.xsort.SortMemoryManager.PAYLOAD_FROM_BUFFER">Constant Field Values</a></li>
</ul>
</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="BUFFER_FROM_PAYLOAD">
<h3>BUFFER_FROM_PAYLOAD</h3>
<div class="member-signature"><span class="modifiers">public static final</span>&nbsp;<span class="return-type">double</span>&nbsp;<span class="element-name">BUFFER_FROM_PAYLOAD</span></div>
<div class="block">Given a data size, this is the multiplier to create the buffer
 size estimate. (Note: since we work with aggregate batches, we
 cannot simply round up to the next power of two: rounding is done
 on a vector-by-vector basis. Here we need to estimate the aggregate
 effect of rounding.</div>
<dl class="notes">
<dt>See Also:</dt>
<dd>
<ul class="see-list">
<li><a href="../../../../../../../constant-values.html#org.apache.drill.exec.physical.impl.xsort.SortMemoryManager.BUFFER_FROM_PAYLOAD">Constant Field Values</a></li>
</ul>
</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="WORST_CASE_BUFFER_RATIO">
<h3>WORST_CASE_BUFFER_RATIO</h3>
<div class="member-signature"><span class="modifiers">public static final</span>&nbsp;<span class="return-type">double</span>&nbsp;<span class="element-name">WORST_CASE_BUFFER_RATIO</span></div>
<div class="block">On really bad days, we will add one more byte (or value) to a vector
 than fits in a power-of-two sized buffer, forcing a doubling. In this
 case, half the resulting buffer is empty.</div>
<dl class="notes">
<dt>See Also:</dt>
<dd>
<ul class="see-list">
<li><a href="../../../../../../../constant-values.html#org.apache.drill.exec.physical.impl.xsort.SortMemoryManager.WORST_CASE_BUFFER_RATIO">Constant Field Values</a></li>
</ul>
</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="MIN_ROWS_PER_SORT_BATCH">
<h3>MIN_ROWS_PER_SORT_BATCH</h3>
<div class="member-signature"><span class="modifiers">public static final</span>&nbsp;<span class="return-type">int</span>&nbsp;<span class="element-name">MIN_ROWS_PER_SORT_BATCH</span></div>
<div class="block">Desperate attempt to keep spill batches from being too small in low memory.
 <p>
 The number is also used for logging: the system will log a warning if
 batches fall below this number which may represent too little memory
 allocated for the job at hand. (Queries operate on big data: many records.
 Batches with too few records are a probable performance hit. But, what is
 too few? It is a judgment call.)</div>
<dl class="notes">
<dt>See Also:</dt>
<dd>
<ul class="see-list">
<li><a href="../../../../../../../constant-values.html#org.apache.drill.exec.physical.impl.xsort.SortMemoryManager.MIN_ROWS_PER_SORT_BATCH">Constant Field Values</a></li>
</ul>
</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="LOW_MEMORY_MERGE_BATCH_RATIO">
<h3>LOW_MEMORY_MERGE_BATCH_RATIO</h3>
<div class="member-signature"><span class="modifiers">public static final</span>&nbsp;<span class="return-type">double</span>&nbsp;<span class="element-name">LOW_MEMORY_MERGE_BATCH_RATIO</span></div>
<dl class="notes">
<dt>See Also:</dt>
<dd>
<ul class="see-list">
<li><a href="../../../../../../../constant-values.html#org.apache.drill.exec.physical.impl.xsort.SortMemoryManager.LOW_MEMORY_MERGE_BATCH_RATIO">Constant Field Values</a></li>
</ul>
</dd>
</dl>
</section>
</li>
</ul>
</section>
</li>
<!-- ========= CONSTRUCTOR DETAIL ======== -->
<li>
<section class="constructor-details" id="constructor-detail">
<h2>Constructor Details</h2>
<ul class="member-list">
<li>
<section class="detail" id="&lt;init&gt;(org.apache.drill.exec.physical.impl.xsort.SortConfig,long)">
<h3>SortMemoryManager</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="element-name">SortMemoryManager</span><wbr><span class="parameters">(<a href="SortConfig.html" title="class in org.apache.drill.exec.physical.impl.xsort">SortConfig</a>&nbsp;config,
 long&nbsp;opMemoryLimit)</span></div>
</section>
</li>
</ul>
</section>
</li>
<!-- ============ METHOD DETAIL ========== -->
<li>
<section class="method-details" id="method-detail">
<h2>Method Details</h2>
<ul class="member-list">
<li>
<section class="detail" id="updateEstimates(int,int,int)">
<h3>updateEstimates</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="return-type">boolean</span>&nbsp;<span class="element-name">updateEstimates</span><wbr><span class="parameters">(int&nbsp;batchDataSize,
 int&nbsp;batchRowWidth,
 int&nbsp;batchRowCount)</span></div>
<div class="block">Update the data-driven memory use numbers including:
 <ul>
 <li>The average size of incoming records.</li>
 <li>The estimated spill and output batch size.</li>
 <li>The estimated number of average-size records per
 spill and output batch.</li>
 <li>The amount of memory set aside to hold the incoming
 batches before spilling starts.</li>
 </ul>
 <p>
 Under normal circumstances, the amount of memory available is much
 larger than the input, spill or merge batch sizes. The primary question
 is to determine how many input batches we can buffer during the load
 phase, and how many spill batches we can merge during the merge
 phase.</div>
<dl class="notes">
<dt>Parameters:</dt>
<dd><code>batchDataSize</code> - the overall size of the current batch received from
 upstream</dd>
<dd><code>batchRowWidth</code> - the average width in bytes (including overhead) of
 rows in the current input batch</dd>
<dd><code>batchRowCount</code> - the number of actual (not filtered) records in
 that upstream batch</dd>
<dt>Returns:</dt>
<dd>true if the estimates changed, false if the previous estimates
 remain valid</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="consolidateBatches(long,int,int)">
<h3>consolidateBatches</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="return-type"><a href="SortMemoryManager.MergeTask.html" title="class in org.apache.drill.exec.physical.impl.xsort">SortMemoryManager.MergeTask</a></span>&nbsp;<span class="element-name">consolidateBatches</span><wbr><span class="parameters">(long&nbsp;allocMemory,
 int&nbsp;inMemCount,
 int&nbsp;spilledRunsCount)</span></div>
<div class="block">Choose a consolidation option during the merge phase depending on memory
 available. Preference is given to moving directly onto merging (with no
 additional spilling) when possible. But, if memory pressures don't allow
 this, we must spill batches and/or merge on-disk spilled runs, to reduce
 the final set of runs to something that can be merged in the available
 memory.
 <p>
 Logic is here (returning an enum) rather than in the merge code to allow
 unit testing without actually needing batches in memory.</div>
<dl class="notes">
<dt>Parameters:</dt>
<dd><code>allocMemory</code> - amount of memory currently allocated (this class knows the total
          memory available)</dd>
<dd><code>inMemCount</code> - number of incoming batches in memory (the number is important, not
          the in-memory size; we get the memory size from
          <tt>allocMemory</tt>)</dd>
<dd><code>spilledRunsCount</code> - the number of runs sitting on disk to be merged</dd>
<dt>Returns:</dt>
<dd>whether to <tt>SPILL</tt> in-memory batches, whether to
         <tt>MERGE<tt> on-disk batches to create a new, larger run, or whether
         to do nothing (<tt>NONE</tt>) and instead advance to the final merge</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="multiply(int,double)">
<h3>multiply</h3>
<div class="member-signature"><span class="modifiers">public static</span>&nbsp;<span class="return-type">int</span>&nbsp;<span class="element-name">multiply</span><wbr><span class="parameters">(int&nbsp;byteSize,
 double&nbsp;multiplier)</span></div>
</section>
</li>
<li>
<section class="detail" id="isSpillNeeded(long,long)">
<h3>isSpillNeeded</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="return-type">boolean</span>&nbsp;<span class="element-name">isSpillNeeded</span><wbr><span class="parameters">(long&nbsp;allocatedBytes,
 long&nbsp;incomingSize)</span></div>
</section>
</li>
<li>
<section class="detail" id="hasMemoryMergeCapacity(long,long)">
<h3>hasMemoryMergeCapacity</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="return-type">boolean</span>&nbsp;<span class="element-name">hasMemoryMergeCapacity</span><wbr><span class="parameters">(long&nbsp;allocatedBytes,
 long&nbsp;neededForInMemorySort)</span></div>
</section>
</li>
<li>
<section class="detail" id="freeMemory(long)">
<h3>freeMemory</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="return-type">long</span>&nbsp;<span class="element-name">freeMemory</span><wbr><span class="parameters">(long&nbsp;allocatedBytes)</span></div>
</section>
</li>
<li>
<section class="detail" id="getMergeMemoryLimit()">
<h3>getMergeMemoryLimit</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="return-type">long</span>&nbsp;<span class="element-name">getMergeMemoryLimit</span>()</div>
</section>
</li>
<li>
<section class="detail" id="getSpillBatchRowCount()">
<h3>getSpillBatchRowCount</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="return-type">int</span>&nbsp;<span class="element-name">getSpillBatchRowCount</span>()</div>
</section>
</li>
<li>
<section class="detail" id="getMergeBatchRowCount()">
<h3>getMergeBatchRowCount</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="return-type">int</span>&nbsp;<span class="element-name">getMergeBatchRowCount</span>()</div>
</section>
</li>
<li>
<section class="detail" id="getMemoryLimit()">
<h3>getMemoryLimit</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="return-type">long</span>&nbsp;<span class="element-name">getMemoryLimit</span>()</div>
</section>
</li>
<li>
<section class="detail" id="getRowWidth()">
<h3>getRowWidth</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="return-type">int</span>&nbsp;<span class="element-name">getRowWidth</span>()</div>
</section>
</li>
<li>
<section class="detail" id="getInputBatchSize()">
<h3>getInputBatchSize</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="return-type"><a href="SortMemoryManager.BatchSizeEstimate.html" title="class in org.apache.drill.exec.physical.impl.xsort">SortMemoryManager.BatchSizeEstimate</a></span>&nbsp;<span class="element-name">getInputBatchSize</span>()</div>
</section>
</li>
<li>
<section class="detail" id="getPreferredSpillBatchSize()">
<h3>getPreferredSpillBatchSize</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="return-type">int</span>&nbsp;<span class="element-name">getPreferredSpillBatchSize</span>()</div>
</section>
</li>
<li>
<section class="detail" id="getPreferredMergeBatchSize()">
<h3>getPreferredMergeBatchSize</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="return-type">int</span>&nbsp;<span class="element-name">getPreferredMergeBatchSize</span>()</div>
</section>
</li>
<li>
<section class="detail" id="getSpillBatchSize()">
<h3>getSpillBatchSize</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="return-type"><a href="SortMemoryManager.BatchSizeEstimate.html" title="class in org.apache.drill.exec.physical.impl.xsort">SortMemoryManager.BatchSizeEstimate</a></span>&nbsp;<span class="element-name">getSpillBatchSize</span>()</div>
</section>
</li>
<li>
<section class="detail" id="getMergeBatchSize()">
<h3>getMergeBatchSize</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="return-type"><a href="SortMemoryManager.BatchSizeEstimate.html" title="class in org.apache.drill.exec.physical.impl.xsort">SortMemoryManager.BatchSizeEstimate</a></span>&nbsp;<span class="element-name">getMergeBatchSize</span>()</div>
</section>
</li>
<li>
<section class="detail" id="getBufferMemoryLimit()">
<h3>getBufferMemoryLimit</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="return-type">long</span>&nbsp;<span class="element-name">getBufferMemoryLimit</span>()</div>
</section>
</li>
<li>
<section class="detail" id="mayOverflow()">
<h3>mayOverflow</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="return-type">boolean</span>&nbsp;<span class="element-name">mayOverflow</span>()</div>
</section>
</li>
<li>
<section class="detail" id="isLowMemory()">
<h3>isLowMemory</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="return-type">boolean</span>&nbsp;<span class="element-name">isLowMemory</span>()</div>
</section>
</li>
<li>
<section class="detail" id="hasPerformanceWarning()">
<h3>hasPerformanceWarning</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="return-type">boolean</span>&nbsp;<span class="element-name">hasPerformanceWarning</span>()</div>
</section>
</li>
</ul>
</section>
</li>
</ul>
</section>
<!-- ========= END OF CLASS DATA ========= -->
</main>
<footer role="contentinfo">
<hr>
<p class="legal-copy"><small>Copyright &#169; 2023 <a href="https://www.apache.org/">The Apache Software Foundation</a>. All rights reserved.</small></p>
</footer>
</div>
</div>
</body>
</html>
