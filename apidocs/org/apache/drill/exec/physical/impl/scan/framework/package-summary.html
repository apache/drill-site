<!DOCTYPE HTML>
<html lang="en">
<head>
<!-- Generated by javadoc (17) -->
<title>org.apache.drill.exec.physical.impl.scan.framework (Drill : 1.21.2-SNAPSHOT API)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="description" content="declaration: package: org.apache.drill.exec.physical.impl.scan.framework">
<meta name="generator" content="javadoc/PackageWriterImpl">
<link rel="stylesheet" type="text/css" href="../../../../../../../../stylesheet.css" title="Style">
<link rel="stylesheet" type="text/css" href="../../../../../../../../script-dir/jquery-ui.min.css" title="Style">
<link rel="stylesheet" type="text/css" href="../../../../../../../../jquery-ui.overrides.css" title="Style">
<script type="text/javascript" src="../../../../../../../../script.js"></script>
<script type="text/javascript" src="../../../../../../../../script-dir/jquery-3.6.1.min.js"></script>
<script type="text/javascript" src="../../../../../../../../script-dir/jquery-ui.min.js"></script>
</head>
<body class="package-declaration-page">
<script type="text/javascript">var evenRowColor = "even-row-color";
var oddRowColor = "odd-row-color";
var tableTab = "table-tab";
var activeTableTab = "active-table-tab";
var pathtoroot = "../../../../../../../../";
loadScripts(document, 'script');</script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<div class="flex-box">
<header role="banner" class="flex-header">
<nav role="navigation">
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="top-nav" id="navbar-top">
<div class="skip-nav"><a href="#skip-navbar-top" title="Skip navigation links">Skip navigation links</a></div>
<ul id="navbar-top-firstrow" class="nav-list" title="Navigation">
<li><a href="../../../../../../../../index.html">Overview</a></li>
<li class="nav-bar-cell1-rev">Package</li>
<li>Class</li>
<li><a href="package-use.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../../../../../index-all.html">Index</a></li>
<li><a href="../../../../../../../../help-doc.html#package">Help</a></li>
</ul>
</div>
<div class="sub-nav">
<div>
<ul class="sub-nav-list">
<li>Package:&nbsp;</li>
<li><a href="#package-description">Description</a>&nbsp;|&nbsp;</li>
<li><a href="#related-package-summary">Related Packages</a>&nbsp;|&nbsp;</li>
<li><a href="#class-summary">Classes and Interfaces</a></li>
</ul>
</div>
<div class="nav-list-search"><label for="search-input">SEARCH:</label>
<input type="text" id="search-input" value="search" disabled="disabled">
<input type="reset" id="reset-button" value="reset" disabled="disabled">
</div>
</div>
<!-- ========= END OF TOP NAVBAR ========= -->
<span class="skip-nav" id="skip-navbar-top"></span></nav>
</header>
<div class="flex-content">
<main role="main">
<div class="header">
<h1 title="Package org.apache.drill.exec.physical.impl.scan.framework" class="title">Package org.apache.drill.exec.physical.impl.scan.framework</h1>
</div>
<hr>
<div class="package-signature">package <span class="element-name">org.apache.drill.exec.physical.impl.scan.framework</span></div>
<section class="package-description" id="package-description">
<div class="block">Defines the projection, vector continuity and other operations for
 a set of one or more readers. Separates the core reader protocol from
 the logic of working with batches.

 <h4>Schema Evolution</h4>

 Drill discovers schema on the fly. The scan operator hosts multiple readers.
 In general, each reader may have a distinct schema, though the user typically
 arranges data in a way that scanned files have a common schema (else SQL
 is the wrong tool for analysis.) Still, subtle changes can occur: file A
 is an old version without a new column c, while file B includes the column.
 And so on.
 <p>
 The scan operator works to ensure schema continuity as much as
 possible, smoothing out "soft" schema changes that are simply artifacts of
 reading a collection of files. Only "hard" changes (true changes) are
 passed downstream.
 <p>
 First, let us define three types of schema change:
 <ul>
 <li>Trivial: a change in vectors underlying a column. Column a may
 be a required integer, but if the actual value vector changes, some
 operators treat this as a schema change.</li>
 <li>Soft: a change in column order, but not the type or existence of
 columns. Soft changes cause problems for operators that index columns by
 position, since column positions change.</li>
 <li>Hard: addition or deletion of a column, or change of column
 data type.</li>
 </ul>
 The goal of this package is to smooth out trivial and soft schema changes,
 and avoid hard schema changes where possible. To do so, we must understand
 the sources of schema change.
 <ul>
 <li>Trivial schema changes due to multiple readers. In general, each reader
 should be independent of other readers, since each file is independent of
 other files. Since readers are independent, they should have control over
 the schema (and vectors) used to read the file. However, distinct vectors
 trigger a trivial schema change.</li>
 <li>Schema changes due to readers that discover data schema as the read
 progresses. The start of a file might have two columns, a and b. A second
 batch might discover column c. Then, when reading a second file, the process
 might repeat. In general, if we have already seen column c in the first file,
 there is no need to trigger a schema change upon discovering it in the
 second. (Though there are subtle issues, such as handling required types.)
 </li>
 <li>Schema changes due to columns that appear in one file, but not another.
 This is a variation of the above issue, but occurs across files, as
 explained above.</li>
 <li>Schema changes due to guessing wrong about the type of a missing
 column. A query might request columns a, b and c. The first file has columns
 a and b, forcing the scan operator to "make up" a column c. Typically Drill
 uses a nullable int. But, a later reader might find a column c and realize
 that it is actually a Varchar.</li>
 <li>Actual schema changes in the data: a file might contain a run of numbers,
 only to insert a string later. A file A might have columns a and b, while a
 second file adds column c. (In general, columns are not removed, only added
 or have the type changed.)</li>
 </ul>
 To avoid soft schema changes, this scan
 operator uses a variety of schema smoothing "levels":
 <ul>
 <li>Level 0: anything that the reader might do, such as a JDBC data source
 requesting only the required columns.</li>
 <li>Level 1: for queries with an explicit select (SELECT a, b, c...), the
 result set loader will filter out unwanted columns. So, if file A also
 includes column d, and file B adds d and f, the result set loader will
 project out the unneeded columns, avoiding schema change (and unnecessary
 vector writes.</li>
 <li>Level 2: for multiple readers, or readers with evolving schema, a
 buffering layer fills in missing columns using the type already seen,
 if possible.</li>
 <li>Level 3: soft changes are avoided by projecting table columns (and
 metadata columns) into the order requested by an explicit select.</li>
 <li>Level 4: the scan operator itself monitors the resulting schema,
 watching for changes that cancel out. For example, each reader builds
 its own schema. If the two files have an identical schema, then the resulting
 schemas are identical and no schema change need be advertised downstream.
 </li>
 </ul>
 Keep the above in mind when looking at individual classes. Mapping of
 levels to classes:
 <ul>
 <li>Level 1: <code>LogicalTupleSet</code> in the <code>ResultSetLoader</code>
 class.</li>
 <li>Level 2: <code>ProjectionPlanner</code>, <code>ScanProjection</code> and
 <code>ScanProjector</code>.</li>
 <li>Level 3: <code>ScanProjector</code>.</li>
 <li>Level 4: <code>OperatorRecordBatch.SchemaTracker</code>.</li>
 </ul>
 <h4>Selection List Processing</h4>
 A key challenge in the scan operator is mapping of table schemas to the
 schema returned by the scan operator. We recognize three distinct kinds of
 selection:
 <ul>
 <li>Wildcard: <tt>SELECT *</tt></li>
 <li>Generic: <tt>SELECT columns</tt>, where "columns" is an array of column
 values. Supported only by readers that return text columns.</li>
 <li>Explicit: <tt>SELECT a, b, c, ...</tt> where "a", "b", "c" and so on are
 the <i>expected</i> names of table columns</li>
 </ul>
 Since Drill uses schema-on-read, we are not sure of the table schema until
 we actually ask the reader to open the table (file or other data source.)
 Then, a table can be "early schema" (known at open time) or "late schema"
 (known only after reading data.)
 <p>
 A selection list goes through three distinct phases to result in a final
 schema of the batch returned downstream.
 <ol>
 <li>Query selection planning: resolves column names to metadata (AKA implicit
 or partition) columns, to "*", to the special "columns" column, or to a list
 of expected table columns.</li>
 <li>File selection planning: determines the values of metadata columns based
 on file and/or directory names.</li>
 <li>Table selection planning: determines the fully resolved output schema by
 resolving the wildcard or selection list against the actual table columns.
 A late-schema table may do table selection planning multiple times: once
 each time the schema changes.</li>
 </ul>
 <h4>Output Batch Construction</h4>
 The batches produced by the scan have up to four distinct kinds of columns:
 <ul>
 <li>File metadata (filename, fqn, etc.)</li>
 <li>Directory (partition metadata: (dir0, dir1, etc.)</li>
 <li>Table columns (or the special "columns" column)</li>
 <li>Null columns (expected table columns that turned out to not match any
 actual table column. To avoid errors, Drill returns these as columns filled
 with nulls.</li>
 </ul>
 In practice, the scan operator uses three distinct result set loaders to create
 these columns:
 <ul>
 <li>Table loader: for the table itself. This loader uses a selection layer to
 write only the data needed for the output batch, skipping unused columns.</li>
 <li>Metadata loader: to create the file and directory metadata columns.</li>
 <li>Null loader: to populate the null columns.</li>
 </ul>
 The scan operator merges the three sets of columns to produce the output
 batch. The merge step also performs projection: it places columns into the
 output batch in the order specified by the original SELECT list (or table order,
 if the original SELECT had a wildcard.) Fortunately, this is just involves
 moving around pointers to vectors; no actual data is moved during projection.

 <h4>Class Structure</h4>

 Some of the key classes here include:
 <ul>
 <li><code>RowBatchReader</code> an extremely simple interface for reading data.
 We would like many developers to create new plugins and readers. The simplified
 interface pushes all complexity into the scan framework, leaving the reader to
 just read.</li>
 <li><a href="ShimBatchReader.html" title="class in org.apache.drill.exec.physical.impl.scan.framework"><code>ShimBatchReader</code></a> an implementation of the above that converts from
 the simplified API to add additional structure to work with the result set loader.
 (The base interface is agnostic about how rows are read.)</li>
 <li><code>ScheamNegotiator</code> and interface that allows a batch reader to
 "negotiate" a schema with the scan framework. The scan framework knows the
 columns that are to be projected. The reader knows what columns it can offer.
 The schema negotiator works out how to combine the two. It expresses the result
 as a result set loader. Column writers are defined for all columns that the
 reader wants to read, but only the materialized (projected) columns have actual
 vectors behind them. The non-projected columns are "free-wheeling" "dummy"
 writers.
 </li>

 And, yes, sorry for the terminology. File "readers" read from files, but
 use column "writers" to write to value vectors.</div>
</section>
<section class="summary">
<ul class="summary-list">
<li>
<div id="related-package-summary">
<div class="caption"><span>Related Packages</span></div>
<div class="summary-table two-column-summary">
<div class="table-header col-first">Package</div>
<div class="table-header col-last">Description</div>
<div class="col-first even-row-color"><a href="../package-summary.html">org.apache.drill.exec.physical.impl.scan</a></div>
<div class="col-last even-row-color">
<div class="block">Defines the scan operation implementation.</div>
</div>
<div class="col-first odd-row-color"><a href="../columns/package-summary.html">org.apache.drill.exec.physical.impl.scan.columns</a></div>
<div class="col-last odd-row-color">
<div class="block">Handles the special "columns" column used by the text reader,
 and available to similar readers.</div>
</div>
<div class="col-first even-row-color"><a href="../convert/package-summary.html">org.apache.drill.exec.physical.impl.scan.convert</a></div>
<div class="col-last even-row-color">
<div class="block">Standard type conversion tools for the case in which the input
 types are the standard Java types already supported by the
 <code>ValuesWriter</code> interface.</div>
</div>
<div class="col-first odd-row-color"><a href="../file/package-summary.html">org.apache.drill.exec.physical.impl.scan.file</a></div>
<div class="col-last odd-row-color">
<div class="block">Handles optional file metadata columns: implicit columns and
 partition columns.</div>
</div>
<div class="col-first even-row-color"><a href="../project/package-summary.html">org.apache.drill.exec.physical.impl.scan.project</a></div>
<div class="col-last even-row-color">
<div class="block">Provides run-time semantic analysis of the projection list for the
 scan operator.</div>
</div>
<div class="col-first odd-row-color"><a href="../v3/package-summary.html">org.apache.drill.exec.physical.impl.scan.v3</a></div>
<div class="col-last odd-row-color">
<div class="block">Provides the "version 3" scan framework (which can also be thought of
 as EVF version 2).</div>
</div>
</div>
</div>
</li>
<li>
<div id="class-summary">
<div class="table-tabs" role="tablist" aria-orientation="horizontal"><button id="class-summary-tab0" role="tab" aria-selected="true" aria-controls="class-summary.tabpanel" tabindex="0" onkeydown="switchTab(event)" onclick="show('class-summary', 'class-summary', 2)" class="active-table-tab">All Classes and Interfaces</button><button id="class-summary-tab1" role="tab" aria-selected="false" aria-controls="class-summary.tabpanel" tabindex="-1" onkeydown="switchTab(event)" onclick="show('class-summary', 'class-summary-tab1', 2)" class="table-tab">Interfaces</button><button id="class-summary-tab2" role="tab" aria-selected="false" aria-controls="class-summary.tabpanel" tabindex="-1" onkeydown="switchTab(event)" onclick="show('class-summary', 'class-summary-tab2', 2)" class="table-tab">Classes</button></div>
<div id="class-summary.tabpanel" role="tabpanel">
<div class="summary-table two-column-summary" aria-labelledby="class-summary-tab0">
<div class="table-header col-first">Class</div>
<div class="table-header col-last">Description</div>
<div class="col-first even-row-color class-summary class-summary-tab2"><a href="BasicScanFactory.html" title="class in org.apache.drill.exec.physical.impl.scan.framework">BasicScanFactory</a></div>
<div class="col-last even-row-color class-summary class-summary-tab2">
<div class="block">Basic reader builder for simple non-file readers.</div>
</div>
<div class="col-first odd-row-color class-summary class-summary-tab1"><a href="ManagedReader.html" title="interface in org.apache.drill.exec.physical.impl.scan.framework">ManagedReader</a>&lt;T extends <a href="SchemaNegotiator.html" title="interface in org.apache.drill.exec.physical.impl.scan.framework">SchemaNegotiator</a>&gt;</div>
<div class="col-last odd-row-color class-summary class-summary-tab1">
<div class="block">Extended version of a record reader which uses a size-aware batch mutator.</div>
</div>
<div class="col-first even-row-color class-summary class-summary-tab2"><a href="ManagedScanFramework.html" title="class in org.apache.drill.exec.physical.impl.scan.framework">ManagedScanFramework</a></div>
<div class="col-last even-row-color class-summary class-summary-tab2">
<div class="block">Basic scan framework for a "managed" reader which uses the scan schema
 mechanisms encapsulated in the scan schema orchestrator.</div>
</div>
<div class="col-first odd-row-color class-summary class-summary-tab1"><a href="ManagedScanFramework.ReaderFactory.html" title="interface in org.apache.drill.exec.physical.impl.scan.framework">ManagedScanFramework.ReaderFactory</a></div>
<div class="col-last odd-row-color class-summary class-summary-tab1">
<div class="block">Creates a batch reader on demand.</div>
</div>
<div class="col-first even-row-color class-summary class-summary-tab2"><a href="ManagedScanFramework.ScanFrameworkBuilder.html" title="class in org.apache.drill.exec.physical.impl.scan.framework">ManagedScanFramework.ScanFrameworkBuilder</a></div>
<div class="col-last even-row-color class-summary class-summary-tab2">&nbsp;</div>
<div class="col-first odd-row-color class-summary class-summary-tab1"><a href="SchemaNegotiator.html" title="interface in org.apache.drill.exec.physical.impl.scan.framework">SchemaNegotiator</a></div>
<div class="col-last odd-row-color class-summary class-summary-tab1">
<div class="block">Negotiates the table schema with the scanner framework and provides
 context information for the reader.</div>
</div>
<div class="col-first even-row-color class-summary class-summary-tab2"><a href="SchemaNegotiatorImpl.html" title="class in org.apache.drill.exec.physical.impl.scan.framework">SchemaNegotiatorImpl</a></div>
<div class="col-last even-row-color class-summary class-summary-tab2">
<div class="block">Implementation of the schema negotiation between scan operator and
 batch reader.</div>
</div>
<div class="col-first odd-row-color class-summary class-summary-tab1"><a href="SchemaNegotiatorImpl.NegotiatorListener.html" title="interface in org.apache.drill.exec.physical.impl.scan.framework">SchemaNegotiatorImpl.NegotiatorListener</a></div>
<div class="col-last odd-row-color class-summary class-summary-tab1">&nbsp;</div>
<div class="col-first even-row-color class-summary class-summary-tab2"><a href="ShimBatchReader.html" title="class in org.apache.drill.exec.physical.impl.scan.framework">ShimBatchReader</a></div>
<div class="col-last even-row-color class-summary class-summary-tab2">
<div class="block">Represents a layer of row batch reader that works with a
 result set loader and schema manager to structure the data
 read by the actual row batch reader.</div>
</div>
</div>
</div>
</div>
</li>
</ul>
</section>
</main>
<footer role="contentinfo">
<hr>
<p class="legal-copy"><small>Copyright &#169; 2023 <a href="https://www.apache.org/">The Apache Software Foundation</a>. All rights reserved.</small></p>
</footer>
</div>
</div>
</body>
</html>
